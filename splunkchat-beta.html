<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Splunky Chat AI Assistant</title>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html, body {
        height: 100%;
        overflow: hidden;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a3a 50%, #000002 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .container {
        background: #000002;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 1200px;
        height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e90777;
    }

    .header {
        background: linear-gradient(135d, #10ace7 0%, #82ceed 100%);
        color: white;
        padding: 20px;
        text-align: center;
        border-bottom: 2px solid #000002;
        flex-shrink: 0;
        position: relative;
    }

    .header h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .user-info {
        font-size: 12px;
        opacity: 0.9;
    }

    .help-button {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(233,7,119, 0.2);
        border: 2px solid rgba(233,7,119, 0.5);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .help-button:hover {
        background: rgba(255, 107, 129, 0.3);
        transform: translateY(-50%) scale(1.1);
    }

    /* Help Modal */
    .help-modal {
        position: fixed;
        top: 0;
        right: -100%;
        width: 100%;
        max-width: 500px;
        height: 100%;
        background: #000002;
        box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        transition: right 0.4s ease-in-out;
        overflow-y: auto;
        border-left: 2px solid #3a3a5c;
    }

    .help-modal.active {
        right: 0;
    }

    .help-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s;
    }

    .help-modal-overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    .help-modal-header {
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a3a 50%, #000002 100%);
        color: white;
        padding: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .help-modal-header h2 {
        font-size: 24px;
        font-weight: 600;
    }

    .close-help {
        background: rgba(233,7,119, 0.2);
        border: 2px solid rgba(233,7,119, 0.5);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .close-help:hover {
        background: rgba(255, 107, 129, 0.3);
        transform: translateY(-5%) scale(1.1);
    }

    .help-modal-content {
        padding: 30px;
        color: #e0e0e0;
    }

    .help-section {
        margin-bottom: 30px;
    }

    .help-section h3 {
        color: #10ace7;
        font-size: 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .help-section p {
        line-height: 1.6;
        color: #b0b0b0;
        margin-bottom: 10px;
    }

    .help-section ul {
        margin-left: 20px;
        margin-top: 10px;
    }

    .help-section li {
        margin-bottom: 10px;
        line-height: 1.6;
        color: #b0b0b0;
    }

    .help-example {
        background: #3a3a5c;
        border-left: 4px solid #e90777;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        margin-bottom: 15px;
    }

    .help-example-title {
        color: #82ceed;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .help-example-text {
        color: #e0e0e0;
        font-style: italic;
        line-height: 1.5;
    }

    .help-tip {
        background: rgba(108, 92, 231, 0.1);
        border: 1px solid #e90777;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .help-tip-icon {
        color: #e90777;
        font-size: 20px;
        flex-shrink: 0;
    }

    .help-tip-text {
        color: #b0b0b0;
        line-height: 1.5;
    }

    /* Footer */
    .footer {
        background: #0f0f23;
        color: #808080;
        padding: 15px 20px;
        text-align: center;
        border-top: 2px solid #3a3a5c;
        flex-shrink: 0;
        font-size: 11px;
        line-height: 1.5;
    }

    .footer a {
        color: #e90777;
        text-decoration: none;
    }

    .footer a:hover {
        text-decoration: underline;
    }

    .footer-divider {
        color: #e90777;
        margin: 0 8px;
    }

/* Chat Containers */
    .chat-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        background: #1a1a3a;
        min-height: 0;
    }

    .message {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease-in;
        position: relative;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        align-items: flex-end;
    }

    .message.assistant {
        align-items: flex-start;
    }

    .message-label {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 6px;
        padding: 0 4px;
    }

    .message.user .message-label {
        color: #82ceed;
    }

    .message.assistant .message-label {
        color: #e90777;
    }

    .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 70%;
    }

    .message-content {
        padding: 14px 18px;
        border-radius: 18px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

     .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .message.assistant .message-content {
        background: #2a2a3e;
        color: #e0e0e0;
        border-bottom-left-radius: 4px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid #3a3a4e;
    }

    /* Message Buttons */
    .message-buttons-top,
    .message-buttons-bottom {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
    }

    .message-buttons-top {
        margin-bottom: 8px;
    }

    .message-buttons-bottom {
        margin-top: 8px;
    }

    .message-button {
        background: rgba(16, 172, 231, 0.2);
        border: 1px solid rgba(16, 172, 231, 0.5);
        color: #10ace7;
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .message-button:hover {
        background: rgba(16, 172, 231, 0.3);
        border-color: #10ace7;
        transform: translateY(-1px);
    }

    .message-button:active {
        transform: translateY(0);
    }

    /* Message Stats */
    .message-stats {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 10px;
        color: #82ceed;
        background: rgba(16, 172, 231, 0.1);
        border: 1px solid rgba(16, 172, 231, 0.3);
        padding: 4px 10px;
        border-radius: 6px;
    }

    .stat-item {
        display: inline-flex;
        align-items: center;
        gap: 3px;
    }

    .stat-divider {
        color: rgba(16, 172, 231, 0.5);
    }

    /* Markdown Styling for Dark Mode */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
        margin-top: 16px;
        margin-bottom: 8px;
        font-weight: 600;
        line-height: 1.25;
        color: #e90777;
    }

    .message-content h1 {
        font-size: 1.8em;
        border-bottom: 2px solid #3a3a4e;
        padding-bottom: 8px;
    }

    .message-content h2 {
        font-size: 1.5em;
        border-bottom: 1px solid #3a3a4e;
        padding-bottom: 6px;
    }

    .message-content h3 {
        font-size: 1.25em;
    }

    .message-content p {
        margin-bottom: 12px;
        line-height: 1.6;
        color: #e0e0e0;
    }

    .message-content ul,
    .message-content ol {
        margin-bottom: 12px;
        margin-left: 20px;
        line-height: 1.6;
    }

    .message-content li {
        margin-bottom: 4px;
        color: #e0e0e0;
    }

    .message-content code {
        background: #1a1a24;
        padding: 3px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: #ff79c6;
        border: 1px solid #3a3a4e;
    }

    .message.user .message-content code {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
    }

    .message-content pre {
        background: #1a1a24;
        padding: 14px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 12px;
        border: 1px solid #3a3a4e;
    }

    .message-content pre code {
        background: transparent;
        padding: 0;
        color: #f8f8f2;
        display: block;
        line-height: 1.5;
        border: none;
    }

    .message-content blockquote {
        border-left: 4px solid #667eea;
        padding-left: 12px;
        margin: 12px 0;
        color: #b0b0b0;
        font-style: italic;
    }

    .message-content a {
        color: #667eea;
        text-decoration: none;
    }

    .message-content a:hover {
        text-decoration: underline;
        color: #8896ff;
    }

    .message.user .message-content a {
        color: white;
        text-decoration: underline;
    }

    .message-content table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 12px;
        overflow-x: auto;
        display: block;
    }

    .message-content table th,
    .message-content table td {
        border: 1px solid #3a3a4e;
        padding: 10px;
        text-align: left;
    }

    .message-content table th {
        background-color: #2a2a3e;
        font-weight: 600;
        color: #a0a0ff;
    }

    .message-content table td {
        color: #e0e0e0;
    }

    .message-content hr {
        border: none;
        border-top: 2px solid #3a3a4e;
        margin: 16px 0;
    }

    .message-content strong {
        font-weight: 600;
        color: #ffffff;
    }

    .message-content em {
        font-style: italic;
        color: #d0d0d0;
    }

    .input-container {
        padding: 20px;
        background: #000000;
        border-top: 2px solid #e90777;
        flex-shrink: 0;
    }

    .input-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    #userInput {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #3a3a4e;
        border-radius: 25px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s, background 0.3s;
        background: #2a2a3e;
        color: #e0e0e0;
        resize: none;
        min-height: 48px;
        max-height: 200px;
        overflow-y: auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.5;
    }

    #userInput:focus {
        border-color: #e90777;
        background: #323244;
    }

    #userInput::placeholder {
        color: #6a6a7a;
    }

    button {
        padding: 12px 24px;
        background: linear-gradient(135deg, #10ace7 0%, #82ceed 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        flex-shrink: 0;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    button:active {
        transform: translateY(0);
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Stop Button Styles */
    #stopButton {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        display: none;
    }

    #stopButton.active {
        display: block;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        opacity: 1;
        cursor: pointer;
    }

    #stopButton.active:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(220, 53, 69, 0.5);
    }

    /* Chat Mode Dropdown - Repositioned */
    .chat-mode-dropdown {
        position: relative;
        display: inline-block;
    }

    .chat-mode-button {
        background: rgba(233,7,119, 0.2);
        border: 2px solid rgba(233,7,119, 0.5);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        white-space: nowrap;
        height: 48px;
    }

    .chat-mode-button:hover {
        background: rgba(233,7,119, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(233, 7, 119, 0.5);
    }

    .chat-mode-button::after {
        content: '‚ñº';
        font-size: 10px;
        transition: transform 0.3s;
    }

    .chat-mode-button.active::after {
        transform: rotate(180deg);
    }

    .chat-mode-menu {
        position: absolute;
        bottom: calc(100% + 8px);
        right: 0;
        background: #1a1a3a;
        border: 2px solid #e90777;
        border-radius: 8px;
        min-width: 240px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.3s;
        z-index: 1000;
    }

    .chat-mode-menu.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .chat-mode-option {
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 1px solid #2a2a4e;
        color: #e0e0e0;
    }

    .chat-mode-option:last-child {
        border-bottom: none;
    }

    .chat-mode-option:hover {
        background: rgba(233,7,119, 0.2);
    }

    .chat-mode-option.selected {
        background: rgba(233,7,119, 0.3);
        border-left: 4px solid #e90777;
    }

    .chat-mode-option-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: #82ceed;
    }

    .chat-mode-option-desc {
        font-size: 11px;
        color: #b0b0b0;
        line-height: 1.3;
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .controls button {
        flex: 1;
        padding: 8px 16px;
        font-size: 12px;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 10px;
        color: #e90777;
        flex-shrink: 0;
    }

    .loading.active {
        display: block;
    }

    .typing-indicator {
        display: inline-block;
    }

    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #667eea;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }

    /* Brain Thinking Animation */
    .thinking-animation {
        display: inline-block;
        font-size: 24px;
        animation: brainWave 1.5s ease-in-out infinite;
    }

    @keyframes brainWave {
        0%, 100% {
            transform: rotate(0deg);
        }
        25% {
            transform: rotate(-15deg);
        }
        75% {
            transform: rotate(15deg);
        }
    }

    .thinking-message {
        display: none;
        padding: 14px 18px;
        border-radius: 18px;
        background: #2a2a3e;
        color: #e0e0e0;
        border-bottom-left-radius: 4px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid #3a3a4e;
        max-width: 70%;
        margin-bottom: 20px;
        margin-left: 20px;
    }

    .thinking-message.active {
        display: flex;
        align-items: center;
        gap: 10px;
        animation: fadeIn 0.3s ease-in;
    }

    .thinking-text {
        color: #b0b0b0;
        font-style: italic;
    }

    .error-message {
        background-color: #4a2c3a;
        color: #ff6b81;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #ff6b81;
    }

    /* Scrollbar styling */
    .chat-container::-webkit-scrollbar,
    .help-modal::-webkit-scrollbar {
        width: 10px;
    }

    .chat-container::-webkit-scrollbar-track,
    .help-modal::-webkit-scrollbar-track {
        background: #1a1a3a;
    }

    .chat-container::-webkit-scrollbar-thumb,
    .help-modal::-webkit-scrollbar-thumb {
        background: #4a4a6e;
        border-radius: 5px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover,
    .help-modal::-webkit-scrollbar-thumb:hover {
        background: #5a5a8e;
    }

    @media (max-width: 600px) {
        body {
            padding: 0;
        }

        .container {
            height: 100vh;
            max-height: 100vh;
            border-radius: 0;
        }

        .message-wrapper {
            max-width: 85%;
        }

        .help-modal {
            max-width: 100%;
        }

        .help-button {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }

        .header h1 {
            font-size: 18px;
        }

        .input-wrapper {
            flex-wrap: wrap;
        }

        .chat-mode-dropdown {
            width: 100%;
            order: 3;
        }

        .chat-mode-button {
            width: 100%;
            justify-content: center;
        }
    }
</style>
</head>
<body>
    <!-- Help Modal Overlay -->
    <div class="help-modal-overlay" id="helpOverlay"></div>
    
    <!-- Help Modal -->
    <div class="help-modal" id="helpModal">
        <div class="help-modal-header">
            <h2>üí° Help & Examples</h2>
            <button class="close-help" onclick="closeHelp()">√ó</button>
        </div>
        <div class="help-modal-content">
            <!-- CUSTOMIZE THIS SECTION WITH YOUR OWN CONTENT -->
            <div class="help-section">
                <h3>üöÄ Getting Started</h3>
                <p>Welcome to the Splunky Chat! This AI assistant is here to help you with various tasks. <br>
                    Splunky will ask you questions and give you guidance.  <br>
                    Simply type your question or request in the input box and press Enter or click Send.</p>
            </div>
            <div class="help-section">
                <h3>üó®Ô∏è Chat Modes ‚öôÔ∏è</h3>
                <div class="help-example">
                    <div class="help-example-title">üó£Ô∏è Basic Chat:</div>
                    <div class="help-example-text">Get help with meeting planning with your sales teams with a 'Choose-your-own-adventure' style workflow.</div>
                </div>
                <div class="help-example">
                    <div class="help-example-title">üéØ Live Meeting Chat:</div>
                    <div class="help-example-text">Have Splunky help you while you're in a meeting.  Ask questions to get fast and effective answers!</div>
                </div>
                <div class="help-example">
                    <div class="help-example-title">üîç SPL Help Chat:</div>
                    <div class="help-example-text">Need to spell SPL?  Ask Splunky! (‚ö†Ô∏èNot all SPL examples will work‚ö†Ô∏è)</div>
                </div>
            </div>
            <div class="help-section"></div>
                <h3>üìù Example Prompts</h3>
                <div class="help-example">
                    <div class="help-example-title">Sales Situations:</div>
                    <div class="help-example-text">"I have an upcoming meeting with (company name) and will be talking to a (role/position)."</div>
                </div>
                <div class="help-example">
                    <div class="help-example-title">SPL Help:</div>
                    <div class="help-example-text">"Write SPL that shows ..."</div>
                </div>
                <div class="help-example">
                    <div class="help-example-title">Creative Writing:</div>
                    <div class="help-example-text">"Write a short, but convincing email ..."</div>
                </div>
                <div class="help-example">
                    <div class="help-example-title">Customer Rebuttal:</div>
                    <div class="help-example-text">"Customer mentioned MS Sentinel... HELP!"</div>
                </div>
            </div>
            <div class="help-section">
                <h3>üí¨ Tips for Better Results</h3>
                <ul>
                    <li><strong>Be specific:</strong> The more details you provide, the better the response</li>
                    <li><strong>Ask follow-up questions:</strong> Continue the conversation to refine answers</li>
                    <li><strong>Use examples:</strong> Show what you're looking for with examples</li>
                    <li><strong>Request formats:</strong> Ask for bullet points, step-by-step guides, or specific formats</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>üîß Features</h3>
                <ul>

                    <li><strong>Chat Modes:</strong> Toggle between Chat Modes for specific tasks</li>
                    <li><strong>Markdown Support:</strong> Responses are formatted with headers, lists, code blocks, and more</li>
                    <li><strong>Code Highlighting:</strong> Code snippets are automatically highlighted for readability</li>
                    <li><strong>Export Chat:</strong> Download your conversation as a markdown file</li>
                    <li><strong>Copy Message:</strong> Copy Splunky's output to MarkDown text</li>
                    <li><strong>Clear Chat:</strong> Start fresh with a clean conversation</li>
                    <li><strong>Stop Generation:</strong> Click the Stop button to halt the AI's response at any time</li>
                    
                </ul>
            </div>
            <div class="help-tip">
                <div class="help-tip-icon">üí°</div>
                <div class="help-tip-text">
                    <strong>Pro Tip:</strong> You can press Enter to send messages quickly, or Shift+Enter to add a new line without sending. Use the Stop button if you need to interrupt a long response.
                </div>
            </div>
            <div class="help-section">
                <h3>‚ö†Ô∏è Important Notes</h3>
                <ul>
                    <li>This AI assistant is powered by LM Studio running remotely</li>
                    <li>Your conversations are logged for quality and improvement purposes</li>
                    <li><strong>The AI may occasionally make mistakes - always verify important information</strong></li>
                    <li>For sensitive topics (medical, legal), please consult qualified professionals</li>
                </ul>
            </div>
            <!-- END OF CUSTOMIZABLE SECTION -->
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ü§ñ Splunky Chat AI Assistant for SE/SAs</h1>
            <button class="help-button" onclick="openHelp()" title="Help & Examples">?</button>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-label">Splunky</div>
                <div class="message-wrapper">
                    <div class="message-content">Hello! I'm Splunky. How can I help you today?</div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="typing-indicator"><span></span><span></span><span></span></div>
        </div>

        <div class="thinking-message" id="thinkingIndicator">
            <span class="thinking-animation">üß†</span>
            <span class="thinking-text">Thinking...</span>
        </div>
        
        <div class="input-container">
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)" rows="1"></textarea>
                <button id="stopButton" onclick="stopGeneration()">üõë Stop</button>
                <button id="sendButton" onclick="sendMessage()">üí¨ Send</button>
                
                <!-- Chat Mode Dropdown - Repositioned -->
                <div class="chat-mode-dropdown">
                    <div class="chat-mode-button" id="chatModeButton" onclick="toggleChatMode()">
                        <span id="currentModeLabel">Basic Chat</span>
                    </div>
                    <div class="chat-mode-menu" id="chatModeMenu">
                        <div class="chat-mode-option selected" data-mode="basic" onclick="selectChatMode('basic')">
                            <div class="chat-mode-option-title">üí¨ Basic Chat</div>
                            <div class="chat-mode-option-desc">General to advanced assistance for SEs and SAs</div>
                        </div>
                        <div class="chat-mode-option" data-mode="meeting" onclick="selectChatMode('meeting')">
                            <div class="chat-mode-option-title">üéØ Live Meeting Chat</div>
                            <div class="chat-mode-option-desc">Real-time support during customer meetings</div>
                        </div>
                        <div class="chat-mode-option" data-mode="spl" onclick="selectChatMode('spl')">
                            <div class="chat-mode-option-title">üîç SPL Help Chat</div>
                            <div class="chat-mode-option-desc">SPL query assistance and optimization</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button onclick="clearChat()">Clear Chat</button>
                <button onclick="exportChat()">Export Chat</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <strong>Disclaimer:</strong> ‚ö†Ô∏èThis AI assistant is provided for informational purposes only. Do not rely on it for ANYTHING!‚ö†Ô∏è<span class="footer-divider">|</span><strong>Privacy:</strong> Conversations are logged and may be used for improvement purposes.<span class="footer-divider">|</span><a href="#" onclick="openHelp(); return false;">Help</a><span class="footer-divider">|</span>¬© 2024 Your Company Name
        </div>
    </div>

    <script>
    // HARDCODED CONFIGURATION - Modify these values as needed
    const HARDCODED_CONFIG = {
        lmStudioUrl: 'http://splunklogs.com:1234',
        modelName: 'gpt-oss-120b',
        loggingEndpoint: '/api/log',
    };

    // Chat Mode System Prompts
// Chat Mode System Prompts - Enhanced Version
const CHAT_MODES = {
    basic: {
        name: 'Basic Chat',
        prompt: `You are Splunky, a knowledgeable and friendly AI assistant specifically designed to help Splunk Sales Engineers (SEs) and Solution Architects (SAs). Your primary role is to assist with:
**User Navigation Guidelines**
- When asked about working with Sales Reps and/or customers, offer a "choose your own adventure" style step by step engagement. 
- Always ask if this is a prep meeting, live meeting, workshop or if the SE needs questions answered.
- It is important to ask the SE if the customer prefers to buy on "Outcomes or Solution Selling" compared to "Consultative Selling"
- If it is a live meeting respond to requests and offer next steps in the "choose your own adventure" style.
Provide a numbered list for the SE to choose from and execute those requests based on the SE's choices.  Offer to go back to the list when it feels nature or the SE requests it.
Ask the SE for inputs to options you present to the user with pauses.  
1. Ask if the SE is having a prep meeting with the Sales Team which includes the Sales Manager who is in charge of helping the customer succeed.  
        If it is a prep meeting, help the SE understand whether the customer is a prospect or existing customer. 
        Ask the SE if the meeting is about Cyber Security or Compliance, Operational effectiveness, Observability or other topics.
        Help the SE and the Sales Manager by coming up with creating a compelling and convincing set of sales play steps for the initial meeting.  
        Ask the SE for a link to the customer's website and analyze the website and provide a summary of what the customer or company does.
2. Ask the SE whether who the customer's roles or personas are.
3. List any potential compliance requirements the customer may have.
4. Based on the customer's roles or personas, provide a list of simple, but effective bullet points about them.
        Provide a list of 3 to 4 open ended questions in decending order of importance and effectiveness that the Sales Rep or the SE should ask the customer.
        Provide nested follow up questions.  
        The SE will enter in the custome's responses, answers or questions and you will provide effective and powerful responses that the SE will relay back to the customer.
        You need to also address Splunk's competition. Ask the SE if there are any competitors the customer may be looking at.
        Also provide laddered questions that the SE can ask the customer.  For example, if the customer is looking at a Splunk competitor, the followup laddered questions should have a NO answer from the customer.  Since we want the customer to buy Splunk, we want laddered questions where the customer answers YES.
        Provide viable Splunk Solutions that map back to the customer's responses and requirements.
5. If the SE is asking for a workshop, provide step-by-step guidance to conduct powerful, effective and efficent workshops.  Assume that the workshops are for existing Splunk customers who could be new to Splunk, seasoned experts at Splunk or needs to know other cool and innovative use cases Splunk can solve for them.
6. Lastly, provide compelling and effective next steps or 'call to actions' for but the sales team and the customer, respectively to help secure another meeting with the customer based on the conversation between the SE and the customer.

1. **Sales Situations & Customer Interactions:**
   - Provide insights and talking points for customer meetings
   - Help craft compelling value propositions
   - Assist with technical questions that may arise during sales calls
   - Offer competitive analysis and positioning strategies
   - Promote the SE as an Advisory role, trust-building and Outcome-oriented, value proposition

2. **Technical Guidance:**
   - Explain Splunk features, capabilities, and use cases
   - Provide architecture recommendations
   - Help with integration questions
   - Offer solutions to common technical challenges

3. **Communication & Documentation:**
   - Draft emails, proposals, and technical documents
   - Create executive summaries and business justifications
   - Help structure presentations and demos
   - Provide clear, professional communication templates

4. **Industry Knowledge:**
   - Offer insights on industry trends and use cases
   - Provide relevant examples and case studies
   - Help understand customer pain points by vertical
   - Suggest relevant Splunk and/or Cisco solutions for specific industries and use cases

5. **Better Together = Splunk + Cisco**
    - Splunk was acquired by Cisco in 2024
    - Ask if the customer has any Cisco products and if so, ask what they are.
    - Splunk and Cisco is better together!  Provide relevant Cisco products that would integrate into Splunk.  If the customer already has Cisco products, provide added value for the customer.

**Your Communication Style:**
- Be professional yet approachable
- Use clear, concise language
- Provide actionable insights
- When writing SPL or code, format it properly, but only if the user asks for SPL.  You may suggest providing SPL if you think it would be helpful, but ask first.
- Ask clarifying questions when needed
- Admit when you're unsure and offer to explore alternatives
- If the SE or SA need short and concise answers, pay attention to wording like "I just need..." or similar.

**Important Guidelines:**
- Always prioritize accuracy over speed
- Pay close attention to the user's request.  Ask for clarification if you are not sure.
- Provide context and reasoning for recommendations
- Suggest multiple approaches when applicable
- Be mindful of Splunk best practices and guidelines
- Focus on solutions that benefit both the customer and Splunk
- NEVER provide or suggest any pricing for any products.  If asked, defer the user to the Sales Rep for pricing information.

Remember: You're here to make the SE/SA's job easier and more effective. Be helpful, knowledgeable, and supportive!`
    },
    meeting: {
        name: 'Live Meeting Chat',
        prompt: `You are Splunky, a real-time AI assistant supporting Splunk Sales Engineers during live customer meetings and sales calls. Your role is to provide:

- Quick, concise answers to technical questions during presentations
- Real-time data points, statistics, and competitive differentiators
        Also provide laddered questions that the SE can ask the customer.  For example, if the customer is looking at a Splunk competitor, the followup laddered questions should have a NO answer from the customer.  Since we want the customer to buy Splunk, we want laddered questions where the customer answers YES.
        Provide viable Splunk and/or Cisco Solutions that map back to the customer's responses and requirements.
- Product feature clarifications and use case examples
- Objection handling suggestions - used laddered questions 
- Follow-up action items and next steps

**Response Format:**
- Lead with the answer first (bottom-line-up-front)
- Keep responses concise (2-3 sentences unless detail requested)
- Use bullet points for multiple items
- Provide "copy-paste ready" language when appropriate

Keep responses brief, actionable, and meeting-appropriate. Prioritize speed and clarity.`
    },
    spl: {
        name: 'SPL Help Chat',
        prompt: `You are Splunky, an expert SPL (Search Processing Language) assistant for Splunk professionals. Your expertise includes:

- Writing and optimizing SPL queries
- Explaining SPL commands and syntax
- Debugging SPL errors and performance issues
- Converting requirements into efficient SPL searches
- Best practices for search optimization
- Advanced SPL techniques (subsearches, joins, lookups, etc.)
- Statistical and visualization commands

**Response Format:**
Always provide SPL in properly formatted code blocks:
\`\`\`spl
index=main sourcetype=access_combined
| stats count by status
\`\`\`

Structure every SPL response with:
1. **The Query:** Formatted, executable SPL code, do NOT add any comments in the SPL code
2. **Explanation:** What the query does step-by-step in a separate section
3. **Performance Notes:** Why this approach is efficient

Provide clear, executable SPL code with explanations. Format queries properly and highlight performance considerations.`
    }
};

function getCurrentSystemPrompt() {
    const mode = CHAT_MODES[currentChatMode];
    if (!mode || !mode.prompt) {
        console.error('Invalid chat mode or missing prompt:', currentChatMode);
        return 'You are a helpful assistant.';
    }
    return mode.prompt;
}

    let conversationHistory = [];
    let isProcessing = false;
    let chatStartTime = null;
    let userHasScrolled = false;
    let abortController = null;
    let currentChatMode = 'basic';

    // Configure marked.js options
    marked.setOptions({
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true
    });

    // Chat Mode Functions
    function toggleChatMode() {
        const menu = document.getElementById('chatModeMenu');
        const button = document.getElementById('chatModeButton');
        const isActive = menu.classList.contains('active');
        
        if (isActive) {
            menu.classList.remove('active');
            button.classList.remove('active');
        } else {
            menu.classList.add('active');
            button.classList.add('active');
        }
    }

    function selectChatMode(mode) {
        if (isProcessing) {
            alert('Please wait for the current response to complete before changing chat mode.');
            return;
        }

        // Check if there's conversation history
        if (conversationHistory.length > 0) {
            if (!confirm('Changing chat mode will clear your current conversation. Continue?')) {
                toggleChatMode();
                return;
            }
        }

        currentChatMode = mode;
        
        // Update UI
        document.getElementById('currentModeLabel').textContent = CHAT_MODES[mode].name;
        
        // Update selected option
        document.querySelectorAll('.chat-mode-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
        
        // Close dropdown
        toggleChatMode();
        
        // Clear conversation history
        conversationHistory = [];
        
        // Update welcome message
        chatContainer.innerHTML = `
            <div class="message assistant">
                <div class="message-label">Splunky</div>
                <div class="message-wrapper">
                    <div class="message-content">Chat mode changed to <strong>${CHAT_MODES[mode].name}</strong>. How can I help you?</div>
                </div>
            </div>
        `;
        
        userHasScrolled = false;
    }

    function getCurrentSystemPrompt() {
        return CHAT_MODES[currentChatMode].prompt;
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.querySelector('.chat-mode-dropdown');
        if (!dropdown.contains(e.target)) {
            document.getElementById('chatModeMenu').classList.remove('active');
            document.getElementById('chatModeButton').classList.remove('active');
        }
    });

    // Help Modal Functions
    function openHelp() {
        const helpModal = document.getElementById('helpModal');
        const helpOverlay = document.getElementById('helpOverlay');
        
        helpModal.classList.add('active');
        helpOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeHelp() {
        const helpModal = document.getElementById('helpModal');
        const helpOverlay = document.getElementById('helpOverlay');
        
        helpModal.classList.remove('active');
        helpOverlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close modal on overlay click
    document.addEventListener('click', function(e) {
        if (e.target.id === 'helpOverlay') {
            closeHelp();
        }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeHelp();
        }
    });

    // Track user scrolling
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.addEventListener('scroll', function() {
        const isAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 50;
        userHasScrolled = !isAtBottom;
    });

    function scrollToBottom() {
        if (!userHasScrolled) {
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }
    }

    function resetScroll() {
        userHasScrolled = false;
        scrollToBottom();
    }

    // Auto-resize textarea
    const userInput = document.getElementById('userInput');
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        chatStartTime = new Date();
        
        // Focus on input
        setTimeout(() => {
            userInput.focus();
        }, 100);
    });

    // Stop generation function
    function stopGeneration() {
        if (abortController) {
            abortController.abort();
            abortController = null;
        }
        
        // Reset UI state
        document.getElementById('loadingIndicator').classList.remove('active');
        document.getElementById('thinkingIndicator').classList.remove('active');
        document.getElementById('stopButton').classList.remove('active');
        document.getElementById('sendButton').disabled = false;
        isProcessing = false;
        
        // Add a system message indicating the generation was stopped
        const stopMessageDiv = document.createElement('div');
        stopMessageDiv.className = 'error-message';
        stopMessageDiv.style.backgroundColor = '#3a3a2c';
        stopMessageDiv.style.color = '#ffc107';
        stopMessageDiv.style.borderLeftColor = '#ffc107';
        stopMessageDiv.textContent = '‚ö†Ô∏è Generation stopped by user';
        chatContainer.appendChild(stopMessageDiv);
        scrollToBottom();
    }

    // Copy to clipboard function
    function copyToClipboard(text, button) {
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = '‚úÖ Copied!';
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            button.innerHTML = '‚ùå Failed';
            setTimeout(() => {
                button.innerHTML = 'üìã Copy';
            }, 2000);
        });
    }

    // Scroll to message top
    function scrollToMessageTop(element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Scroll to message bottom
    function scrollToMessageBottom(element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

async function sendMessage() {
    if (isProcessing) return;

    const message = userInput.value.trim();
    if (!message) return;

    const messageStartTime = Date.now();

    // Reset textarea height
    userInput.style.height = 'auto';
    userInput.value = '';
    isProcessing = true;
    document.getElementById('sendButton').disabled = true;
    document.getElementById('stopButton').classList.add('active');
    document.getElementById('loadingIndicator').classList.add('active');

    // Create new AbortController for this request
    abortController = new AbortController();

    // Add user message to chat
    addMessageToChat('user', message);
    conversationHistory.push({ role: 'user', content: message });
    resetScroll();

    try {
        // Get the current system prompt
        const systemPrompt = getCurrentSystemPrompt();
        
        // Build messages array with proper validation
        const messages = [
            {
                role: 'system',
                content: systemPrompt || 'You are a helpful assistant.' // Fallback if undefined
            },
            ...conversationHistory.filter(msg => msg.content && msg.content.trim() !== '') // Filter out any messages with empty content
        ];

        const response = await fetch(`${HARDCODED_CONFIG.lmStudioUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: HARDCODED_CONFIG.modelName,
                messages: messages,
                temperature: 1.0,
                max_tokens: -1,
                stream: true
            }),
            signal: abortController.signal
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Hide loading, show thinking animation
        document.getElementById('loadingIndicator').classList.remove('active');
        document.getElementById('thinkingIndicator').classList.add('active');
        scrollToBottom();

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let assistantMessage = '';
        let messageElement = null;
        let messageDiv = null;
        let totalTokens = 0;
        let firstChunkReceived = false;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = line.slice(6);
                    if (data === '[DONE]') continue;

                    try {
                        const parsed = JSON.parse(data);
                        const content = parsed.choices[0]?.delta?.content;

                        if (content) {
                            // Hide thinking animation on first content chunk
                            if (!firstChunkReceived) {
                                document.getElementById('thinkingIndicator').classList.remove('active');
                                firstChunkReceived = true;
                            }

                            assistantMessage += content;
                            
                            if (!messageElement) {
                                const result = addMessageToChat('assistant', '', true);
                                messageElement = result.contentDiv;
                                messageDiv = result.messageDiv;
                            }
                            
                            // Render markdown in real-time
                            messageElement.innerHTML = marked.parse(assistantMessage);
                            // Apply syntax highlighting to code blocks
                            messageElement.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                            
                            scrollToBottom();
                        }

                        // Track tokens if available
                        if (parsed.usage?.total_tokens) {
                            totalTokens = parsed.usage.total_tokens;
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e);
                    }
                }
            }
        }

        // Ensure thinking animation is hidden
        document.getElementById('thinkingIndicator').classList.remove('active');

        if (assistantMessage) {
            conversationHistory.push({ role: 'assistant', content: assistantMessage });
            
            // Calculate time taken
            const timeTaken = ((Date.now() - messageStartTime) / 1000).toFixed(2);
            
            // Estimate tokens if not provided (rough estimate: ~4 chars per token)
            if (totalTokens === 0) {
                totalTokens = Math.ceil((message.length + assistantMessage.length) / 4);
            }

            // Add message buttons after completion with stats
            if (messageDiv) {
                addMessageButtons(messageDiv, assistantMessage, totalTokens, timeTaken);
            }
            
            // Log the interaction
            logInteraction(message, assistantMessage, totalTokens, timeTaken);
        }

    } catch (error) {
        if (error.name === 'AbortError') {
            console.log('Request was aborted by user');
        } else {
            console.error('Error:', error);
            document.getElementById('loadingIndicator').classList.remove('active');
            document.getElementById('thinkingIndicator').classList.remove('active');
            showError(`Failed to connect to LM Studio. Please ensure LM Studio is running at ${HARDCODED_CONFIG.lmStudioUrl} and CORS is enabled. Error: ${error.message}`);
        }
    } finally {
        isProcessing = false;
        document.getElementById('sendButton').disabled = false;
        document.getElementById('stopButton').classList.remove('active');
        abortController = null;
    }
}

    async function logInteraction(userPrompt, chatOutput, tokensUsed, timeTaken) {
        const logData = {
            timestamp: new Date().toISOString(),
            user: 'anonymous',
            chat_mode: currentChatMode,
            user_prompt: userPrompt,
            chat_output: chatOutput,
            tokens_used: tokensUsed,
            time_taken: timeTaken
        };

        try {
            await fetch(HARDCODED_CONFIG.loggingEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(logData)
            });
        } catch (error) {
            console.error('Logging error:', error);
        }
    }

    function addMessageToChat(role, content, isMarkdown = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        // Add label
        const labelDiv = document.createElement('div');
        labelDiv.className = 'message-label';
        labelDiv.textContent = role === 'user' ? 'You' : 'Splunky';

        // Create wrapper
        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'message-wrapper';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (isMarkdown && role === 'assistant') {
            contentDiv.innerHTML = marked.parse(content);
        } else {
            contentDiv.textContent = content;
        }

        messageDiv.appendChild(labelDiv);
        wrapperDiv.appendChild(contentDiv);
        messageDiv.appendChild(wrapperDiv);
        chatContainer.appendChild(messageDiv);

        scrollToBottom();
        
        return { messageDiv, contentDiv, wrapperDiv };
    }

function addMessageButtons(messageDiv, content, tokens, timeSeconds) {
    const wrapperDiv = messageDiv.querySelector('.message-wrapper');
    
    // Calculate tokens per second
    const tokensPerSecond = timeSeconds > 0 ? (tokens / parseFloat(timeSeconds)).toFixed(1) : '0';
    
    // Top buttons
    const topButtonsDiv = document.createElement('div');
    topButtonsDiv.className = 'message-buttons-top';
    
    const copyTopBtn = document.createElement('button');
    copyTopBtn.className = 'message-button';
    copyTopBtn.innerHTML = 'üìã Copy';
    copyTopBtn.onclick = () => copyToClipboard(content, copyTopBtn);
    
    const bottomBtn = document.createElement('button');
    bottomBtn.className = 'message-button';
    bottomBtn.innerHTML = '‚¨áÔ∏è Bottom';
    bottomBtn.onclick = () => scrollToMessageBottom(messageDiv);
    
    topButtonsDiv.appendChild(copyTopBtn);
    topButtonsDiv.appendChild(bottomBtn);
    
    // Bottom buttons with stats
    const bottomButtonsDiv = document.createElement('div');
    bottomButtonsDiv.className = 'message-buttons-bottom';
    
    const copyBottomBtn = document.createElement('button');
    copyBottomBtn.className = 'message-button';
    copyBottomBtn.innerHTML = 'üìã Copy';
    copyBottomBtn.onclick = () => copyToClipboard(content, copyBottomBtn);
    
    const topBtn = document.createElement('button');
    topBtn.className = 'message-button';
    topBtn.innerHTML = '‚¨ÜÔ∏è Top';
    topBtn.onclick = () => scrollToMessageTop(messageDiv);
    
    // Stats display with tokens per second
    const statsDiv = document.createElement('div');
    statsDiv.className = 'message-stats';
    statsDiv.innerHTML = `
        <span class="stat-item">
            <span>üî¢</span>
            <span>${tokens.toLocaleString()} tokens</span>
        </span>
        <span class="stat-divider">‚Ä¢</span>
        <span class="stat-item">
            <span>‚è±Ô∏è</span>
            <span>${timeSeconds}s</span>
        </span>
        <span class="stat-divider">‚Ä¢</span>
        <span class="stat-item">
            <span>‚ö°</span>
            <span>${tokensPerSecond} t/s</span>
        </span>
    `;
    
    bottomButtonsDiv.appendChild(copyBottomBtn);
    bottomButtonsDiv.appendChild(topBtn);
    bottomButtonsDiv.appendChild(statsDiv);
    
    // Insert top buttons before content
    wrapperDiv.insertBefore(topButtonsDiv, wrapperDiv.firstChild);
    
    // Append bottom buttons after content
    wrapperDiv.appendChild(bottomButtonsDiv);
}

    function clearChat() {
        if (confirm('Are you sure you want to clear the chat history?')) {
            conversationHistory = [];
            chatContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-label">Splunky</div>
                    <div class="message-wrapper">
                        <div class="message-content">Hello! I'm ready to chat. How can I help you today?</div>
                    </div>
                </div>
            `;
            userHasScrolled = false;
        }
    }

    function exportChat() {
        if (conversationHistory.length === 0) {
            alert('No conversation to export.');
            return;
        }

        let markdown = '# Chat Export\n\n';
        markdown += `**Date:** ${new Date().toLocaleString()}\n`;
        markdown += `**Chat Mode:** ${CHAT_MODES[currentChatMode].name}\n\n`;

        conversationHistory.forEach((msg, index) => {
            if (msg.role === 'user') {
                markdown += `**You:** ${msg.content}\n\n`;
            } else {
                markdown += `**Splunky:** ${msg.content}\n\n`;
            }
        });

        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-export-${currentChatMode}-${new Date().getTime()}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        chatContainer.appendChild(errorDiv);
        scrollToBottom();
    }
    </script>
</body>
</html>