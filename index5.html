<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ü§ñ Splunky Chat AI Assistant</title>
        <!-- Marked.js for Markdown parsing -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <!-- Highlight.js for code syntax highlighting -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: #1e1e2e;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #2a2a3e;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #764ba2;
            flex-shrink: 0;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .user-info {
            font-size: 12px;
            opacity: 0.9;
        }

        .help-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .help-button:hover {
            background: rgba(255,113,91, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        /* Help Modal */
        .help-modal {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 500px;
            height: 100%;
            background: #1e1e2e;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transition: right 0.4s ease-in-out;
            overflow-y: auto;
            border-left: 2px solid #2a2a3e;
        }

        .help-modal.active {
            right: 0;
        }

        .help-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .help-modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .help-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .help-modal-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .close-help {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-help:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .help-modal-content {
            padding: 30px;
            color: #e0e0e0;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section h3 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-section p {
            line-height: 1.6;
            color: #b0b0b0;
            margin-bottom: 10px;
        }

        .help-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .help-section li {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #b0b0b0;
        }

        .help-example {
            background: #2a2a3e;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .help-example-title {
            color: #a0a0ff;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .help-example-text {
            color: #e0e0e0;
            font-style: italic;
            line-height: 1.5;
        }

        .help-tip {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .help-tip-icon {
            color: #667eea;
            font-size: 20px;
            flex-shrink: 0;
        }

        .help-tip-text {
            color: #b0b0b0;
            line-height: 1.5;
        }

        /* Footer */
        .footer {
            background: #1a1a2e;
            color: #808080;
            padding: 15px 20px;
            text-align: center;
            border-top: 2px solid #2a2a3e;
            flex-shrink: 0;
            font-size: 11px;
            line-height: 1.5;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer-divider {
            color: #3a3a4e;
            margin: 0 8px;
        }

        .email-setup {
            background: #1e1e2e;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #e0e0e0;
        }

        .email-setup h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .email-setup p {
            margin-bottom: 20px;
            text-align: center;
            color: #b0b0b0;
        }

        .email-input-group {
            width: 100%;
            max-width: 400px;
        }

        .email-input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #3a3a4e;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            background: #2a2a3e;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        .email-input-group input:focus {
            border-color: #667eea;
        }

        .email-input-group button {
            width: 100%;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: #16161e;
            min-height: 0;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .message.assistant .message-content {
            background: #2a2a3e;
            color: #e0e0e0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #3a3a4e;
        }

        /* Markdown Styling for Dark Mode */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.25;
            color: #a0a0ff;
        }

        .message-content h1 {
            font-size: 1.8em;
            border-bottom: 2px solid #3a3a4e;
            padding-bottom: 8px;
        }

        .message-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #3a3a4e;
            padding-bottom: 6px;
        }

        .message-content h3 {
            font-size: 1.25em;
        }

        .message-content p {
            margin-bottom: 12px;
            line-height: 1.6;
            color: #e0e0e0;
        }

        .message-content ul,
        .message-content ol {
            margin-bottom: 12px;
            margin-left: 20px;
            line-height: 1.6;
        }

        .message-content li {
            margin-bottom: 4px;
            color: #e0e0e0;
        }

        .message-content code {
            background: #1a1a24;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #ff79c6;
            border: 1px solid #3a3a4e;
        }

        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
        }

        .message-content pre {
            background: #1a1a24;
            padding: 14px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 12px;
            border: 1px solid #3a3a4e;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: #f8f8f2;
            display: block;
            line-height: 1.5;
            border: none;
        }

        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 12px;
            margin: 12px 0;
            color: #b0b0b0;
            font-style: italic;
        }

        .message-content a {
            color: #667eea;
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
            color: #8896ff;
        }

        .message.user .message-content a {
            color: white;
            text-decoration: underline;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 12px;
            overflow-x: auto;
            display: block;
        }

        .message-content table th,
        .message-content table td {
            border: 1px solid #3a3a4e;
            padding: 10px;
            text-align: left;
        }

        .message-content table th {
            background-color: #2a2a3e;
            font-weight: 600;
            color: #a0a0ff;
        }

        .message-content table td {
            color: #e0e0e0;
        }

        .message-content hr {
            border: none;
            border-top: 2px solid #3a3a4e;
            margin: 16px 0;
        }

        .message-content strong {
            font-weight: 600;
            color: #ffffff;
        }

        .message-content em {
            font-style: italic;
            color: #d0d0d0;
        }

        .input-container {
            padding: 20px;
            background: #1e1e2e;
            border-top: 2px solid #2a2a3e;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        #userInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #3a3a4e;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s, background 0.3s;
            background: #2a2a3e;
            color: #e0e0e0;
        }

        #userInput:focus {
            border-color: #667eea;
            background: #323244;
        }

        #userInput::placeholder {
            color: #6a6a7a;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .controls button {
            flex: 1;
            padding: 8px 16px;
            font-size: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #667eea;
            flex-shrink: 0;
        }

        .loading.active {
            display: block;
        }

        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #667eea;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .error-message {
            background-color: #3d1f1f;
            color: #ff6b6b;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ff6b6b;
        }

        /* Scrollbar styling */
        .chat-container::-webkit-scrollbar,
        .help-modal::-webkit-scrollbar {
            width: 10px;
        }

        .chat-container::-webkit-scrollbar-track,
        .help-modal::-webkit-scrollbar-track {
            background: #16161e;
        }

        .chat-container::-webkit-scrollbar-thumb,
        .help-modal::-webkit-scrollbar-thumb {
            background: #3a3a4e;
            border-radius: 5px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover,
        .help-modal::-webkit-scrollbar-thumb:hover {
            background: #4a4a5e;
        }

        /* Chat interface wrapper */
        #chatInterface {
            display: none;
            flex: 1;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        #chatInterface.active {
            display: flex;
        }

        @media (max-width: 600px) {
            body {
                padding: 0;
            }

            .container {
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }

            .message-content {
                max-width: 85%;
            }

            .help-modal {
                max-width: 100%;
            }

            .help-button {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
        }
    </style>
    </head>
    <body>
        <!-- Help Modal Overlay -->
        <div class="help-modal-overlay" id="helpOverlay" onclick="closeHelp()">dsfasdfsdf</div>
        <!-- Help Modal -->
        <div class="help-modal" id="helpModal">
            <div class="help-modal-header">
                <h2>üí° Help &amp; Examples</h2>
                <button class="close-help" onclick="closeHelp()">√ó</button>
            </div>
            <div class="help-modal-content">
                <!-- CUSTOMIZE THIS SECTION WITH YOUR OWN CONTENT -->
                <div class="help-section">
                    <h3>üöÄ Getting Started</h3>
                    <p>Welcome to the Splunky Chat! This AI assistant is here to help you with various tasks. <br>
                        Splunky will ask you questions and give you guidance.  <br>
                        Simply type your question or request in the input box and press Enter or click Send.</p>
                </div>
                <div class="help-section">
                    <h3>üìù Example Prompts</h3>
                    <div class="help-example">
                        <div class="help-example-title">Sales Situations:</div>
                        <div class="help-example-text">"I have an upcoming meeting with (company name) and will be talking to a (role/position)."</div>
                    </div>
                    <div class="help-example">
                        <div class="help-example-title">Code Help:</div>
                        <div class="help-example-text">"Write a Python function to calculate the fibonacci sequence"</div>
                    </div>
                    <div class="help-example">
                        <div class="help-example-title">Creative Writing:</div>
                        <div class="help-example-text">"Write a short story about a robot learning to paint"</div>
                    </div>
                    <div class="help-example">
                        <div class="help-example-title">Analysis:</div>
                        <div class="help-example-text">"Summarize the main points from this article: [paste text]"</div>
                    </div>
                </div>
                <div class="help-section">
                    <h3>üí¨ Tips for Better Results</h3>
                    <ul>
                        <li>
                            <strong>Be specific:</strong>The more details you provide, the better the response
                        </li>
                        <li>
                            <strong>Ask follow-up questions:</strong>Continue the conversation to refine answers
                        </li>
                        <li>
                            <strong>Use examples:</strong>Show what you're looking for with examples
                        </li>
                        <li>
                            <strong>Request formats:</strong>Ask for bullet points, step-by-step guides, or specific formats
                        </li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>üîß Features</h3>
                    <ul>
                        <li>
                            <strong>Markdown Support:</strong>Responses are formatted with headers, lists, code blocks, and more
                        </li>
                        <li>
                            <strong>Code Highlighting:</strong>Code snippets are automatically highlighted for readability
                        </li>
                        <li>
                            <strong>Export Chat:</strong>Download your conversation as a markdown file
                        </li>
                        <li>
                            <strong>Clear Chat:</strong>Start fresh with a clean conversation
                        </li>
                    </ul>
                </div>
                <div class="help-tip">
                    <div class="help-tip-icon">üí°</div>
                    <div class="help-tip-text">
                        <strong>Pro Tip:</strong>You can press Enter to send messages quickly, or Shift+Enter to add a new line without sending.
                    </div>
                </div>
                <div class="help-section">
                    <h3>‚ö†Ô∏è Important Notes</h3>
                    <ul>
                        <li>This AI assistant is powered by LM Studio running locally</li>
                        <li>Your conversations are logged for quality and improvement purposes</li>
                        <li>The AI may occasionally make mistakes - always verify important information</li>
                        <li>For sensitive topics (medical, legal), please consult qualified professionals</li>
                    </ul>
                </div>
                <!-- END OF CUSTOMIZABLE SECTION -->
            </div>
        </div>
        <div class="container">
            <div class="header">
                <h1>ü§ñ LM Studio Chat</h1>
                <div class="user-info" id="userInfo" style="display:none;"></div>
                <button class="help-button" onclick="openHelp()" title="Help &amp; Examples">?</button>
            </div>
            <!-- Email Setup Screen -->
            <div class="email-setup" id="emailSetup">
                <h2>Welcome! üëã</h2>
                <p>Please enter your email address to personalize your chat experience.</p>
                <div class="email-input-group">
                    <input type="email" id="emailInput" placeholder="your.email@example.com" required><button onclick="submitEmail()">Start Chatting</button>
                </div>
            </div>
            <!-- Chat Interface (hidden initially) -->
            <div id="chatInterface">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant">
                        <div class="message-content">Hello! I'm ready to chat. How can I help you today?</div>
                    </div>
                </div>
                <div class="loading" id="loadingIndicator">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
                <div class="input-container">
                    <div class="input-wrapper">
                        <input type="text" id="userInput" placeholder="Type your message here..." autocomplete="off">
                        <button id="sendButton" onclick="sendMessage()">Send</button>
                    </div>
                    <div class="controls">
                        <button onclick="clearChat()">Clear Chat</button>
                        <button onclick="exportChat()">Export Chat</button>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="footer">
                <strong>Disclaimer:</strong>This AI assistant is provided for informational purposes only. Do not rely on it for medical, legal, or financial advice.<span class="footer-divider">|</span><strong>Privacy:</strong>Conversations are logged and may be used for improvement purposes.<span class="footer-divider">|</span><a href="#" onclick="openHelp(); return false;">Help</a><span class="footer-divider">|</span>¬© 2024 Your Company Name
            </div>
        </div>
        <script>
        // HARDCODED CONFIGURATION - Modify these values as needed
        const HARDCODED_CONFIG = {
            lmStudioUrl: 'http://splunkogs.com:1234',  // Change to your LM Studio IP and port
            modelName: 'gpt-oss-120b',      // Change to your model name
            systemPrompt: `You are a Splunk Sales or Solutions Engineer (SE) and Solutions Architect (SA) assistant. You specialize in creating questions for SEs to ask customers based on the customer's needs. 
            Ask the SE whether who the customer's roles or personas are.
            Ask if the SE is having a prep meeting with the Sales Team which includes the Sales Manager who is in charge of helping the customer succeed.  If it is a prep meeting, help the SE understand whether the customer is a prospect or existing.  Ask the SE for a link to the customer's website and analyze the website and provide a summary of what the customer does.
            List any potential compliance requirements the customer may have.
            Help the SE and the Sales Manager by coming up with creating a compelling and convincing set of sales play steps for the initial meeting.  
            Based on the customer's roles or personas, provide a list of simple, but effective bullet points about them.
            Ask the SE if the meeting is about Cyber Security or Compliance, Operational effectiveness, Observability or other topics.
            Based on the topics, create a list of open ended questions for the SE to ask the customer.  Provide nested follow up questions.  
            The SE will enter in the custome's responses, answers or questions and you will provide effective and powerful responses that the SE will relay back to the customer.
            Also provide laddered questions that the SE can ask the customer. 
            Provide viable Splunk Solutions that map back to the customer's responses and requirements.
            Lastly, provide compelling and effective next steps or 'call to actions' for but the sales team and the customer, respectively to help secure another meeting with the customer based on the conversation between the SE and the customer.
            When asked you will provide Splunk searches, SPL, when asked.`,  // Your hidden system prompt
            loggingEndpoint: '/api/log'  // Nginx logging endpoint
        };

        let conversationHistory = [];
        let isProcessing = false;
        let userEmail = '';
        let chatStartTime = null;

        // Configure marked.js options
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang &amp;&amp; hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // Help Modal Functions
        function openHelp() {
            document.getElementById('helpModal').classList.add('active');
            document.getElementById('helpOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
            document.getElementById('helpOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHelp();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const userInput = document.getElementById('userInput');
            const emailInput = document.getElementById('emailInput');
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' &amp;&amp; !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitEmail();
                }
            });

            // Check if email is stored
            const storedEmail = localStorage.getItem('userEmail');
            if (storedEmail) {
                userEmail = storedEmail;
                showChatInterface();
            }
        });

        function submitEmail() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }

            userEmail = email;
            localStorage.setItem('userEmail', email);
            showChatInterface();
        }

        function showChatInterface() {
            document.getElementById('emailSetup').style.display = 'none';
            const chatInterface = document.getElementById('chatInterface');
            chatInterface.classList.add('active');
            document.getElementById('userInfo').textContent = `Chatting as: ${userEmail}`;
            document.getElementById('userInfo').style.display = 'block';
            
            chatStartTime = new Date();
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('userInput').focus();
            }, 100);
        }

        async function sendMessage() {
            if (isProcessing) return;

            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();

            if (!message) return;

            const messageStartTime = Date.now();

            // Add user message to chat
            addMessageToChat('user', message);
            conversationHistory.push({ role: 'user', content: message });

            userInput.value = '';
            isProcessing = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('loadingIndicator').classList.add('active');

            try {
                const response = await fetch(`${HARDCODED_CONFIG.lmStudioUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: HARDCODED_CONFIG.modelName,
                        messages: [
                            {
                                role: 'system',
                                content: HARDCODED_CONFIG.systemPrompt
                            },
                            ...conversationHistory
                        ],
                        temperature: 0.7,
                        max_tokens: -1,
                        stream: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';
                let messageElement = null;
                let totalTokens = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content;

                                if (content) {
                                    assistantMessage += content;
                                    
                                    if (!messageElement) {
                                        messageElement = addMessageToChat('assistant', '', true);
                                    }
                                    
                                    // Render markdown in real-time
                                    messageElement.innerHTML = marked.parse(assistantMessage);
                                    // Apply syntax highlighting to code blocks
                                    messageElement.querySelectorAll('pre code').forEach((block) => {
                                        hljs.highlightElement(block);
                                    });
                                    
                                    scrollToBottom();
                                }

                                // Track tokens if available
                                if (parsed.usage?.total_tokens) {
                                    totalTokens = parsed.usage.total_tokens;
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }

                if (assistantMessage) {
                    conversationHistory.push({ role: 'assistant', content: assistantMessage });
                    
                    // Calculate time taken
                    const timeTaken = ((Date.now() - messageStartTime) / 1000).toFixed(2);
                    
                    // Estimate tokens if not provided (rough estimate: ~4 chars per token)
                    if (totalTokens === 0) {
                        totalTokens = Math.ceil((message.length + assistantMessage.length) / 4);
                    }

                    // Log the interaction
                    logInteraction(message, assistantMessage, totalTokens, timeTaken);
                }

            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to connect to LM Studio. Please ensure LM Studio is running at ${HARDCODED_CONFIG.lmStudioUrl} and CORS is enabled.`);
            } finally {
                isProcessing = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('loadingIndicator').classList.remove('active');
            }
        }

        async function logInteraction(userPrompt, chatOutput, tokensUsed, timeTaken) {
            const logData = {
                timestamp: new Date().toISOString(),
                user: userEmail,
                user_prompt: userPrompt,
                chat_output: chatOutput,
                tokens_used: tokensUsed,
                time_taken: timeTaken
            };

            try {
                await fetch(HARDCODED_CONFIG.loggingEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(logData)
                });
            } catch (error) {
                console.error('Logging error:', error);
                // Don't show error to user, just log it
            }
        }

        function addMessageToChat(role, content, isMarkdown = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isMarkdown &amp;&amp; role === 'assistant') {
                contentDiv.innerHTML = marked.parse(content);
            } else {
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            scrollToBottom();
            return contentDiv;
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            // Use requestAnimationFrame for smooth scrolling
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                conversationHistory = [];
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = `
                    </script>
    </body>
</html>
